image: docker:18.09.7
services:
  - docker:18.09.7-dind

variables:
  DOCKER_HOST: "tcp://localhost:2375"
  FF_GITLAB_REGISTRY_HELPER_IMAGE: 1

stages:
 - build

before_script:
  - docker info
  - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY

coda_build_image:
  stage: build
  variables:
    IMAGE: coda-build
  script:
    - docker pull $CI_REGISTRY_IMAGE/$IMAGE || true
    - docker build --pull --cache-from $CI_REGISTRY_IMAGE/$IMAGE -t $CI_REGISTRY_IMAGE/$IMAGE $IMAGE
    - docker push $CI_REGISTRY_IMAGE/$IMAGE
  only:
    changes:
      - .gitlab-ci.yml
      - coda-build/*
