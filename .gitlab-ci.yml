image: registry.cmusatyalab.org/coda/coda-packaging/coda-deb-build:latest

stages:
 - prepare
 - build
 - deploy

# (re)build docker build containers
.prepare:docker_template: &docker_template
  stage: prepare
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker info
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker pull $CI_REGISTRY_IMAGE:$IMAGE || true
    - docker build --pull --cache-from $CI_REGISTRY_IMAGE:$IMAGE -t $CI_REGISTRY_IMAGE:$IMAGE $IMAGE
    - docker push $CI_REGISTRY_IMAGE:$IMAGE

prepare:docker_build:
  <<: *docker_template
  variables:
    DOCKER_DRIVER: overlay
    DOCKER_HOST: "tcp://localhost:2375"
    IMAGE: coda-build
  only:
    changes:
      - coda-build/*

prepare:docker_deb_build:
  <<: *docker_template
  variables:
    DOCKER_DRIVER: overlay
    DOCKER_HOST: "tcp://localhost:2375"
    IMAGE: coda-deb-build
  only:
    changes:
      - coda-deb-build/*

prepare:docker_rpm_build:
  <<: *docker_template
  variables:
    DOCKER_DRIVER: overlay
    DOCKER_HOST: "tcp://localhost:2375"
    IMAGE: coda-rpm-build
  only:
    changes:
      - coda-rpm-build/*


# build Coda binary packages
.setup:
  stage: prepare
  variables:
    REF: master
  script: ./setup-release.sh
  artifacts:
    paths:
      - coda-*.tar.?z
      - debian/
      - "*.src.rpm"
    expire_in: 1 week


.build:deb: &build_deb
  stage: build
  image: registry.cmusatyalab.org/coda/coda-packaging/coda-deb-build:latest
  script: ./build-debs.sh
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

.build:rpm: &build_rpm
  stage: build
  image: registry.cmusatyalab.org/coda/coda-packaging/coda-rpm-build:latest
  script: ./build-rpms.sh
  cache:
    key: ${CI_JOB_NAME}
    paths:
      - cache/
  artifacts:
    paths:
      - dist/*.rpm
    expire_in: 1 week

.deploy:
  stage: deploy
  script:
    - echo "copy artifacts to coda repos"
  when: manual


.build:jessie-amd64:
  <<: *build_deb

.build:jessie-i386:
  <<: *build_deb

.build:stretch-amd64:
  <<: *build_deb

.build:stretch-i386:
  <<: *build_deb

.build:trusty-amd64:
  <<: *build_deb

.build:trusty-i386:
  <<: *build_deb

.build:xenial-amd64:
  <<: *build_deb

.build:xenial-i386:
  <<: *build_deb

.build:bionic-amd64:
  <<: *build_deb

.build:bionic-i386:
  <<: *build_deb

.build:cosmic-amd64:
  <<: *build_deb

.build:cosmic-i386:
  <<: *build_deb

.build:fedora-28-x86_64:
  <<: *build_rpm

.build:fedora-28-i386:
  <<: *build_rpm

.build:fedora-29-x86_64:
  <<: *build_rpm

.build:fedora-29-i386:
  <<: *build_rpm

.build:fedora-30-x86_64:
  <<: *build_rpm

.build:fedora-30-i386:
  <<: *build_rpm

.build:epel-6-x86_64:
  <<: *build_rpm

.build:epel-7-coda-x86_64:
  <<: *build_rpm

